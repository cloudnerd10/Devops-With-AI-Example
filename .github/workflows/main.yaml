name: Analyze Logs on Failure

on:
  workflow_dispatch:  # Manual trigger
  workflow_run:
    workflows: ["Build"]
    types:
      - completed

jobs:
  analyze-failure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Run tests and capture logs
        run: |
          echo "Running tests..."
          python main.py
          { echo "Test log output:"; echo "Simulating test failure..."; exit 1; } 2>&1 | tee "$GITHUB_WORKSPACE/test-logs.txt"
        id: run-tests

      # Capture the log file generated by the previous step
      - name: Save logs to final log file
        if: failure()
        run: |
          echo "Saving logs..."

          # Define the log file location
          LOG_FILE="$GITHUB_WORKSPACE/logs.txt"

          # Check if test-logs.txt exists and append it to the final log file
          if [ -f "$GITHUB_WORKSPACE/test-logs.txt" ]; then
            echo "------------------- Step: run-tests -------------------" >> $LOG_FILE
            cat "$GITHUB_WORKSPACE/test-logs.txt" >> $LOG_FILE
          else
            echo "No logs captured from tests." >> $LOG_FILE
          fi

      # Send logs to Python script for analysis
      - name: Analyze logs using Python script
        if: failure()
        run: |
          python process_logs.py "$GITHUB_WORKSPACE/logs.txt"
