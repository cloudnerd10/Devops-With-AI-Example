name: Analyze Logs on Failure

on:
  workflow_dispatch:  # Manual trigger
  workflow_run:
    workflows: ["Build"]
    types:
      - completed

jobs:
  analyze-failure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Run tests and capture output
        run: |
          echo "Running tests..."
          python main.py
          { echo "Test log output:"; echo "Simulating test failure..."; exit 1; } 2>&1 | tee $GITHUB_WORKSPACE/test-logs.txt
        id: run-tests

      # Capture the log file generated by the previous step
      - name: Save logs to file
        if: failure()
        run: |
          echo "Saving logs..."

          LOG_FILE=$GITHUB_WORKSPACE/logs.txt
          
          # Capture output of the run-tests step from the log file
          echo "------------------- Step: run-tests -------------------" >> $LOG_FILE
          cat $GITHUB_WORKSPACE/test-logs.txt >> $LOG_FILE || echo "No logs captured from tests."

          # Optionally, capture environment variables for additional context
          echo "------------------- Environment Info -------------------" >> $LOG_FILE
          env >> $LOG_FILE

      # Send logs to Python script for analysis
      - name: Analyze logs using Python script
        if: failure()
        run: |
          python process_logs.py "$GITHUB_WORKSPACE/logs.txt"
